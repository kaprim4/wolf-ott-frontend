<mat-card class="cardWithShadow theme-card">
    <ng-container *ngIf="isLoading">
        <mat-progress-bar mode="query"></mat-progress-bar>
    </ng-container>
    <mat-card-header>
        <mat-card-title class="m-b-0" style="color:white;">
            Quick M3U
        </mat-card-title>
    </mat-card-header>
    <mat-card-content class="b-t-1">
        <mat-stepper #stepper>
            <mat-step [stepControl]="packageForm">
                <form class="mt-3" [formGroup]="packageForm"> <!-- Use Bootstrap's margin-top -->
                    <ng-template matStepLabel>Package</ng-template>
                    <div>
                        <mat-form-field appearance="outline" class="w-100">
                            <mat-label class="mat-subtitle-2 fw-bold">Package</mat-label>
                            <mat-select formControlName="package" (selectionChange)="onSelectPackage($event)"
                                        (openedChange)="onPackagesDropdownOpened($event)" required>
                                <mat-select-trigger>
                                    {{ getSelectedPackageName() }}
                                </mat-select-trigger>
                                <mat-option>
                                    <ngx-mat-select-search
                                        [formControl]="packageSearchCtrl"
                                        placeholderLabel="Search"
                                        noEntriesFoundLabel="No options found">
                                    </ngx-mat-select-search>
                                </mat-option>
                                <mat-option *ngFor="let pkg of filteredPackages" [value]="pkg.id"
                                            (click)="$event.stopPropagation()">
                                    {{ pkg.packageName }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>

                        <mat-accordion>
                            <mat-expansion-panel hideToggle>
                                <mat-expansion-panel-header class="d-flex justify-content-between"
                                                            (click)="panelOpened = !panelOpened">
                                    <mat-panel-title class="fw-bold w-100">Advanced</mat-panel-title>
                                    <mat-panel-description class="icon-container">
                                        <mat-icon *ngIf="!panelOpened">expand_more</mat-icon>
                                        <mat-icon *ngIf="panelOpened">expand_less</mat-icon>
                                    </mat-panel-description>
                                </mat-expansion-panel-header>
                                <mat-form-field appearance="outline" class="w-100 m-t-4">
                                    <mat-label>Username</mat-label>
                                    <input matInput type="text" formControlName="username" class="fw-bold"/>
                                </mat-form-field>
                                <mat-form-field appearance="outline" class="w-100">
                                    <mat-label>Password</mat-label>
                                    <input matInput type="text" formControlName="password" class="fw-bold"/>
                                </mat-form-field>
                                <!--
                                <mat-form-field appearance="outline" class="w-100">
                                    <mat-label>VPN</mat-label>
                                    <input matCheck type="checkbox" formControlName="use_vpn" class="fw-bold" />
                                </mat-form-field>
                                -->
                                <div class="d-flex justify-content-between p-8">
                                    <div class="d-flex align-items-start">
                                        <mat-label class="mat-subtitle-2 f-w-600">Use WolfGuard</mat-label>
                                    </div>
                                    <div class="align-items-end">
                                        <mat-slide-toggle formControlName="use_vpn" color="primary"></mat-slide-toggle>
                                    </div>
                                </div>

                            </mat-expansion-panel>
                        </mat-accordion>

                        <div class="text-right mt-2" *ngIf="!isCreated"> <!-- Add Bootstrap margin-top to this div -->
                            <button mat-flat-button color="primary" matStepperNext [disabled]="packageForm.invalid">
                                Next
                            </button>
                        </div>
                    </div>
                </form>
            </mat-step>
            <mat-step [stepControl]="bundleForm">
                <form class="" [formGroup]="bundleForm">
                    <ng-template matStepLabel>Bundle</ng-template>
                    <div class="row d-flex flex-column justify-content-start align-items-start p-24">
                        <div class="m-l-4">
                            <span class="d-block text-light">Select Bundle:</span>
                            <mat-radio-group formControlName="bundle" (change)="bundleToggle($event)">
                                <mat-radio-button value="packages" [checked]="selectedBundleOption === 'packages'">All
                                    (bouquets)
                                </mat-radio-button>
                                <mat-radio-button value="presets" [checked]="selectedBundleOption === 'presets'">
                                    Presets
                                </mat-radio-button>
                            </mat-radio-group>
                        </div>

                        <ng-container [ngSwitch]="bundleForm.get('bundle')?.value">

                            <ng-container *ngSwitchCase="'packages'">
                                <mat-form-field appearance="outline" class="w-100 m-r-24">
                                    <mat-select formControlName="package" (selectionChange)="onSelectPackage($event)">
                                        <mat-select-trigger>
                                            {{ selectedPackage ? selectedPackage.packageName : 'Select Package' }}
                                        </mat-select-trigger>
                                        <mat-option *ngFor="let pkg of packages" [value]="pkg.id"
                                                    (click)="$event.stopPropagation()">
                                            {{ pkg.packageName }}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </ng-container>

                            <ng-container *ngSwitchCase="'presets'">
                                <mat-form-field appearance="outline" class="w-100 m-r-24">
                                    <mat-select formControlName="preset" (selectionChange)="onSelectPreset($event)">
                                        <mat-select-trigger>
                                            {{ getSelectedPresetName() || 'Select Preset' }}
                                        </mat-select-trigger>
                                        <mat-option *ngFor="let preset of presets" [value]="preset.id"
                                                    (click)="$event.stopPropagation()">
                                            {{ preset.presetName }}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </ng-container>
                        </ng-container>
                    </div>
                    <div class="d-flex align-items-center justify-content-between" *ngIf="!isCreated">
                        <button mat-flat-button color="warn" matStepperPrevious>
                            Back
                        </button>
                        <button mat-flat-button color="primary" matStepperNext (click)="createLine()" [disabled]="isLoading">
                            Create Line
                        </button>
                    </div>
                </form>
            </mat-step>
            <mat-step>
                <ng-template matStepLabel>Finish</ng-template>
                <div class="row">
                    <div class="col-sm-12 col-md-9 col-lg-9">
                        <mat-form-field appearance="outline" class="w-100" color="primary">
                            <mat-label>Playlist URL</mat-label>
                            <input matInput type="text" [value]="downloadUrl" disabled>
                        </mat-form-field>
                    </div>
                    <div class="d-flex align-items-center col-sm-12 col-md-3 col-lg-3">
                        <button class="action-btn" mat-icon-button (click)="copyToClipboard(downloadUrl)">
                            <mat-icon>content_copy</mat-icon>
                        </button>
                        <button class="action-btn" mat-icon-button (click)="downloadM3U(downloadUrl)">
                            <mat-icon>download</mat-icon>
                        </button>
                    </div>
                </div>
            </mat-step>
        </mat-stepper>
    </mat-card-content>
</mat-card>
